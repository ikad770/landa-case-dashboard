<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Landa Quantum – Troubleshoot Suite (V18.9-Fishbone)</title>

<link rel="icon" type="image/svg+xml"
  href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect x='2' y='2' width='36' height='36' rx='8' fill='%23000000' opacity='0.85' stroke='%23ffffff10'/%3E%3Ccircle cx='20' cy='20' r='8' fill='%2300aeef'/%3E%3C/svg%3E">

<style>
:root{
  --bg:#0b1016; --bg2:#0e1420; --panel:rgba(18,24,34,.6); --glass:rgba(22,30,45,.55);
  --text:#e8f0ff; --muted:#9bb0d0; --border:rgba(255,255,255,.08);
  --accent:#00aeef; --accent2:#3bd0ff; --ok:#4ade80; --warn:#f8c537; --err:#ff4967;
  --header:56px; --aside-w:260px; --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font:14px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(0,174,239,.18), transparent 60%),
    radial-gradient(1000px 500px at 110% 10%, rgba(59,208,255,.15), transparent 55%),
    linear-gradient(180deg, var(--bg), var(--bg2) 60%, #0a0f15);
  animation: breathe 14s ease-in-out infinite;
  overflow:hidden;
}
@keyframes breathe{0%,100%{filter:brightness(1) saturate(1)}50%{filter:brightness(1.07) saturate(1.06)}}
.hidden{display:none!important}

/* Panels/Buttons */
.panel{
  border:1px solid var(--border); border-radius:var(--radius); padding:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  box-shadow:0 18px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
  backdrop-filter:blur(14px) saturate(1.08);
  transition:box-shadow .25s, transform .25s, border-color .25s;
}
.panel:hover{ box-shadow:0 20px 46px rgba(0,174,239,.24), inset 0 0 0 1px rgba(59,208,255,.12); border-color:rgba(59,208,255,.35); transform:translateY(-1px) }
.btn{
  border:1px solid var(--border); color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  padding:10px 14px; border-radius:12px; cursor:pointer;
  transition:.18s transform,.18s box-shadow,.18s border-color;
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 16px 38px rgba(0,0,0,.36); border-color:rgba(59,208,255,.45) }
.btn.primary{ border-color:var(--accent); background:linear-gradient(180deg, rgba(0,174,239,.28), rgba(0,174,239,.08)); color:#fff }
.btn.ghost{ background:transparent }
.btn.small{ padding:6px 10px; border-radius:9px; font-size:12.5px }
.btn.danger{ border-color:rgba(255,73,103,.5); color:#fff }

.badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted) }
.badge.ok{ color:#0e1; border-color:rgba(74,222,128,.45) }
.badge.err{ color:#ff889e; border-color:rgba(255,73,103,.55) }
.badge.dim{ opacity:.8 }
.kv{ display:flex; gap:6px } .k{color:var(--muted)} .v{color:var(--text)}

.toast-wrap{ position:fixed; right:16px; top:calc(var(--header) + 8px); display:flex; flex-direction:column; gap:8px; z-index:110 }
.toast{ padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(20,26,38,.85); box-shadow:0 14px 28px rgba(0,0,0,.35) }
.toast.ok{ border-color:rgba(74,222,128,.5) } .toast.err{ border-color:rgba(255,73,103,.55) }
#particles{ position:fixed; inset:0; z-index:-1; pointer-events:none }

/* Layout */
.header{
  position:sticky; top:0; z-index:100;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  height:var(--header); padding:8px 14px;
  background:linear-gradient(180deg, rgba(10,14,20,.82), rgba(10,14,20,.34));
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(10px) saturate(1.1);
  box-shadow:0 4px 14px rgba(0,0,0,.35);
}
.header-left{ display:flex; align-items:center; gap:10px; min-width:0 }
.header-title{ display:flex; align-items:center; gap:10px; min-width:0 }
.header-title h1{ font-size:16px; letter-spacing:.4px; margin:0; opacity:.95; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.header .badge-env{ font-size:11px; color:#9bb0d0; border:1px solid var(--border); padding:2px 8px; border-radius:999px }
.header .logo-mini svg{ width:28px; height:28px; animation:pulseGlow 3.2s ease-in-out infinite; transform-origin:center }
@keyframes pulseGlow{0%{filter:drop-shadow(0 0 0 rgba(0,174,239,0));transform:scale(1)}50%{filter:drop-shadow(0 0 12px rgba(0,174,239,.45));transform:scale(1.05)}100%{filter:drop-shadow(0 0 0 rgba(0,174,239,0));transform:scale(1)}}
.header .menu-btn{ display:none; gap:8px; align-items:center }
.header .menu-btn .bar{ width:18px; height:2px; background:#cfe7ff; border-radius:2px; box-shadow:0 0 8px rgba(0,174,239,.35) }

.wrap{ display:grid; grid-template-columns:var(--aside-w) 1fr; height:calc(100vh - var(--header)) }
.aside{
  border-right:1px solid var(--border);
  background:linear-gradient(180deg, rgba(14,20,30,.6), rgba(14,20,30,.25));
  backdrop-filter:blur(8px); padding:16px 14px;
  position:sticky; top:var(--header); height:calc(100vh - var(--header));
  overflow:auto; z-index:10;
}
.main{ padding:16px 16px 60px; overflow:auto }

.nav{display:flex; flex-direction:column; gap:8px}
.nav .item{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border-radius:10px; text-decoration:none; color:var(--text); opacity:.85;
  transition:.18s transform,.18s box-shadow,.18s border-color;
}
.nav .item:hover{ transform:translateY(-1px); box-shadow:0 14px 30px rgba(0,0,0,.35); border-color:rgba(59,208,255,.35); opacity:1}
.nav .item.active{ border-color:var(--accent); box-shadow:0 0 0 1px inset rgba(59,208,255,.25), 0 12px 28px rgba(0,174,239,.25)}
.nav .badge{ margin-left:auto; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted)}

.grid{display:grid; gap:12px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
@media (max-width:1100px){ .grid.cols-3{grid-template-columns:1fr 1fr} }
@media (max-width:780px){
  .header{padding:8px 10px}
  .header .menu-btn{display:flex}
  .header-title h1{font-size:15px; max-width:62vw}
  .wrap{grid-template-columns:1fr}
  .aside{position:fixed; top:var(--header); left:0; bottom:0; height:auto; width:min(82vw,320px);
         transform:translateX(-105%); transition:transform .25s ease; box-shadow:16px 0 40px rgba(0,0,0,.45); z-index:120}
  body.aside-open .aside{transform:translateX(0)}
  .main{padding:14px 12px 72px}
  .grid.cols-2,.grid.cols-3{grid-template-columns:1fr}
}

/* Inputs */
.label{ display:block; color:var(--muted); margin:6px 2px 6px }
.input, textarea, .file{
  width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)); outline:none;
}
textarea{ min-height:84px; resize:vertical }

/* Chips & Pills */
.chips{display:flex; gap:8px; flex-wrap:wrap}
.chip{
  padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
}
.chip.active{ background:linear-gradient(180deg, rgba(0,174,239,.28), rgba(0,174,239,.08)); border-color:rgba(0,174,239,.55) }

/* Dropdown (glass) */
.dd{ position:relative; display:inline-block; width:100%; max-width:100% }
.dd-btn{
  width:100%; padding:10px 38px 10px 12px; border:1px solid var(--border); border-radius:10px;
  color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
  backdrop-filter:blur(10px);
  text-align:left; cursor:pointer;
  transition:border-color .18s, box-shadow .18s, transform .18s;
}
.dd-btn:hover{ transform:translateY(-1px); box-shadow:0 16px 38px rgba(0,0,0,.28); border-color:rgba(59,208,255,.35) }
.dd-btn:focus{ outline:none; border-color:rgba(59,208,255,.45); box-shadow:0 0 0 3px rgba(59,208,255,.18) }
.dd-arrow{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  width:16px; height:16px; pointer-events:none; opacity:.9;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23bfe9ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") center/16px 16px no-repeat;
  filter:drop-shadow(0 0 6px rgba(0,174,239,.35));
}
.dd-list{
  position:absolute; left:0; right:0; top:calc(100% + 6px);
  border:1px solid var(--border); border-radius:12px;
  background:linear-gradient(180deg, rgba(18,24,34,.96), rgba(18,24,34,.88));
  backdrop-filter:blur(12px) saturate(1.05);
  box-shadow:0 22px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03);
  max-height:260px; overflow:auto; padding:6px 0; display:none; z-index:30;
}
.dd.open .dd-list{ display:block }
.dd-item{ padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px; transition:background .12s }
.dd-item:hover{ background:rgba(59,208,255,.12) }
.dd-item[aria-selected="true"]::before{
  content:""; width:8px; height:8px; border-radius:2px; background:linear-gradient(180deg, var(--accent), var(--accent2));
  box-shadow:0 0 12px rgba(0,174,239,.5);
}
.dd-empty{ padding:8px 12px; color:var(--muted) }

/* Issue selection cards (dashboard-ish) */
.issue-grid{display:flex;flex-wrap:wrap;gap:12px}
.issue-card{
  flex:1 1 180px; min-width:180px; max-width:260px;
  padding:14px; border:1px solid var(--border); border-radius:14px; cursor:pointer;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
  box-shadow:0 10px 26px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.03);
  transition:.2s;
}
.issue-card:hover{ transform:translateY(-2px); border-color:rgba(59,208,255,.45); box-shadow:0 18px 40px rgba(0,174,239,.28) }
.issue-card .title{font-weight:600;margin-bottom:6px}
.issue-card .sub{color:var(--muted);font-size:12.5px}

/* RCA new UI */
.rca-steps{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px }
.rca-step{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12.5px; opacity:.9 }
.rca-step.active{ border-color:var(--accent); background:linear-gradient(180deg, rgba(0,174,239,.28), rgba(0,174,239,.08)); color:#fff }
.rca-bar{ display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap }
.rca-tabs{ display:flex; gap:8px; flex-wrap:wrap }
.rca-tab{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; cursor:pointer; opacity:.92; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)) }
.rca-tab.active{ border-color:rgba(0,174,239,.6); background:linear-gradient(180deg, rgba(0,174,239,.24), rgba(0,174,239,.06)); color:#fff }
.rca-spec{ display:grid; grid-template-columns: 1.2fr .9fr .9fr .9fr; gap:8px; align-items:center }
@media (max-width:820px){ .rca-spec{ grid-template-columns: 1fr; } }
.spec-pill{ padding:6px 8px; border:1px solid var(--border); border-radius:9px; font-size:12.5px; color:var(--muted) }
.dev-pill{ padding:6px 8px; border:1px solid var(--border); border-radius:9px; font-size:12.5px }
.dev-ok{ border-color:rgba(74,222,128,.5); color:#d7ffe1; background:linear-gradient(180deg, rgba(74,222,128,.18), rgba(74,222,128,.06)) }
.dev-err{ border-color:rgba(255,73,103,.55); color:#ffd4db; background:linear-gradient(180deg, rgba(255,73,103,.18), rgba(255,73,103,.06)) }
.dev-na { border-color:rgba(255,255,255,.18); color:#c9d5e8; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)) }

.rca-row{
  border:1px solid var(--border); border-radius:14px; padding:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
}
.rca-row + .rca-row{ margin-top:10px }
.role-badges{ display:flex; gap:6px; flex-wrap:wrap }
.role{ font-size:11.5px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:#bcd0ea }
.role.op{ border-color:rgba(74,222,128,.35) }
.role.adv{ border-color:rgba(248,197,55,.38) }
.role.fse{ border-color:rgba(0,174,239,.45) }

/* Modal/KPI etc inherited */
.case-card{ border:1px solid var(--border); border-radius:14px; padding:14px; display:grid; grid-template-columns:auto 1fr auto; gap:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); box-shadow:0 14px 34px rgba(0,0,0,.32), inset 0 0 0 1px rgba(255,255,255,.03); transition:.25s}
.case-card:hover{ box-shadow:0 18px 40px rgba(0,174,239,.2), inset 0 0 0 1px rgba(59,208,255,.12); border-color:rgba(59,208,255,.35); transform:translateY(-1px) }
.case-card .stripe{ width:6px; border-radius:8px; background:linear-gradient(180deg, var(--accent), var(--accent2)) }

.modal-back{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:140 }
.modal{
  width:min(880px, 94vw); max-height:88vh; overflow:auto; border:1px solid var(--border); border-radius:16px; padding:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025)); box-shadow:0 30px 80px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03);
  animation:pop .22s ease;
}
@keyframes pop{from{transform:translateY(8px) scale(.98); opacity:0}to{transform:translateY(0) scale(1); opacity:1}}
</style>
</head>

<body>
<canvas id="particles"></canvas>
<div class="toast-wrap" id="toasts"></div>

<!-- LOGIN -->
<section id="loginPage">
  <div class="auth panel center" style="width:min(460px, 92vw)">
    <div class="logo" style="display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:14px">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 110" aria-label="Landa Digital Printing">
        <defs>
          <linearGradient id="lg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00aeef"/><stop offset="100%" stop-color="#3bd0ff"/></linearGradient>
          <filter id="g" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <text x="50%" y="50%" text-anchor="middle" fill="url(#lg)" filter="url(#g)"
              font-family="Segoe UI, Inter, system-ui, sans-serif" font-weight="700" font-size="56" letter-spacing="1">Landa</text>
        <text x="50%" y="82%" text-anchor="middle" fill="#9bb0d0"
              font-family="Segoe UI, Inter, system-ui, sans-serif" font-size="18" letter-spacing="2">Digital Printing</text>
      </svg>
      <div class="subtitle" style="color:var(--muted);font-size:12.5px;letter-spacing:.6px">Quantum Troubleshoot Suite</div>
    </div>
    <h2 style="margin:0 0 6px; font-size:18px; letter-spacing:.5px; opacity:.92; text-align:center">Sign in to continue</h2>
    <label class="label" for="authUser">Username</label>
    <input class="input" id="authUser" placeholder="Expert" autocomplete="username">
    <label class="label" for="authPass">Password</label>
    <input class="input" id="authPass" type="password" placeholder="Password" autocomplete="current-password">
    <button class="btn primary" style="width:100%;margin-top:14px" id="btnLogin">Login</button>
  </div>
</section>

<!-- APP -->
<div class="app hidden" id="appRoot">
  <header class="header">
    <div class="header-left">
      <button class="menu-btn btn small" id="btnMenu" aria-label="Toggle menu" title="Menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>
      <div class="header-title" id="logoHome" title="Go to Dashboard" style="cursor:pointer">
        <div class="logo-mini" aria-hidden="true">
          <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="36" height="36" rx="8" fill="rgba(0,0,0,0.78)" stroke="rgba(255,255,255,0.08)"/>
            <circle cx="20" cy="20" r="8" fill="#00aeef">
              <animate attributeName="r" values="8;9;8" dur="2.6s" repeatCount="indefinite"/>
            </circle>
          </svg>
        </div>
        <h1>Landa Quantum – Troubleshoot Suite</h1>
      </div>
    </div>
    <span class="badge badge-env">V18.9-Fishbone</span>
  </header>

  <div class="wrap">
    <aside class="aside" id="aside">
      <nav class="nav">
        <a class="item active" href="#" data-route="dashboard"><span>Dashboard</span></a>
        <a class="item" href="#" data-route="create"><span>Create Case</span></a>
        <a class="item" href="#" data-route="cases"><span>All Cases</span><span class="badge" id="casesCount">0</span></a>
        <a class="item" href="#" data-route="diagnosis"><span>Root Cause Analyzer</span></a>
        <a class="item" href="#" data-route="settings"><span>Settings</span></a>
        <a class="item" href="#" id="btnLogout"><span>Logout</span></a>
      </nav>
    </aside>

    <main class="main">
      <!-- Dashboard -->
      <section id="page-dashboard" class="page">
        <div class="grid cols-3">
          <div class="panel"><div class="title">Total Cases</div><div style="font-size:28px;margin-top:6px" id="kpiTotal">0</div><div class="help">All cases saved locally</div></div>
          <div class="panel"><div class="title">With Attachments</div><div style="font-size:28px;margin-top:6px" id="kpiFiles">0</div><div class="help">Cases containing files</div></div>
          <div class="panel"><div class="title">Last Updated</div><div style="font-size:28px;margin-top:6px" id="kpiUpdated">—</div><div class="help">Most recent save</div></div>
        </div>
        <div class="panel" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div class="title">Quick Actions</div>
            <div>
              <button class="btn" onclick="go('create')">+ New Case</button>
              <button class="btn" onclick="go('cases')">View All</button>
              <button class="btn" onclick="exportCSV()">Export CSV</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Create Case (unchanged structurally, kept short here for focus) -->
      <section id="page-create" class="page hidden">
        <div class="panel">
          <h2 style="margin:0 0 10px">Create New Case</h2>
          <form id="caseForm" onsubmit="saveCase(event)">
            <div class="grid cols-2">
              <div>
                <label class="label">Machine Type *</label>
                <div class="chips" id="machineTypeChips">
                  <div class="chip active" data-type="Simplex">Simplex</div>
                  <div class="chip" data-type="Duplex">Duplex</div>
                </div>
                <input type="hidden" id="machineType" value="Simplex">
              </div>
              <div>
                <label class="label">Model *</label>
                <div id="dd-model" class="dd" style="max-width:130px"></div>
              </div>

              <div>
                <label class="label">SF Case *</label>
                <input class="input" id="sfCase" inputmode="numeric" placeholder="123456" style="max-width:180px">
              </div>
              <div>
                <label class="label">Software Version</label>
                <input class="input" id="softwareVersion" placeholder="4.2.11" style="max-width:160px">
              </div>

              <div class="full"><hr style="border:0; border-top:1px solid var(--border)"></div>

              <div class="full">
                <label class="label">Issue Summary *</label>
                <input class="input" id="issueSummary" placeholder="One line summary">
              </div>
              <div class="full">
                <label class="label">Symptoms / Error Messages</label>
                <textarea id="symptoms" class="input" placeholder="Short bullets or error codes"></textarea>
              </div>

              <div class="full">
                <label class="label">Troubleshooting (steps)</label>
                <div id="tsSteps"></div>
                <button class="btn small" type="button" onclick="addStep()">+ Add step</button>
              </div>

              <div class="full">
                <label class="label">Solution Implemented *</label>
                <textarea id="solution" class="input" placeholder="What fixed the issue"></textarea>
              </div>

              <div class="inline full" style="margin-top:6px">
                <button class="btn primary" type="submit">Save Case</button>
                <button class="btn ghost" type="button" onclick="go('cases')">View All</button>
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- Cases -->
      <section id="page-cases" class="page hidden">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
            <h2 style="margin:0">All Cases</h2>
            <div class="inline" style="flex-wrap:wrap; gap:8px">
              <input id="searchBox" class="input" placeholder="Search text (Issue / Model / System)" style="min-width:220px">
              <button class="btn" onclick="renderCases()">Apply</button>
              <button class="btn" onclick="exportCSV()">Export CSV</button>
            </div>
          </div>
        </div>
        <div id="casesList" class="grid cols-1" style="margin-top:14px"></div>
      </section>

      <!-- Root Cause Analyzer – NEW -->
      <section id="page-diagnosis" class="page hidden">
        <div class="panel">
          <h2 style="margin:0 0 10px">Root Cause Analyzer – Fishbone Troubleshooter</h2>
          <p class="help">Follow the guided diagnostic to identify the source of a problem step-by-step.</p>

          <div class="rca-steps">
            <span class="rca-step active" id="rcaStep1">1) Select issue</span>
            <span class="rca-step" id="rcaStep2">2) Classify</span>
            <span class="rca-step" id="rcaStep3">3) Checklists & Specs</span>
            <span class="rca-step" id="rcaStep4">4) Summary</span>
          </div>

          <!-- Step 0 – Select Issue -->
          <div id="diagSelect" class="panel" style="margin-top:10px">
            <h3 style="margin:0 0 10px">Select Issue to Diagnose</h3>
            <p class="help">Choose the problem type to start the guided analysis:</p>
            <div class="issue-grid">
              <div class="issue-card" onclick="startDiagnosis('setoff')">
                <div class="title">SetOff</div><div class="sub">Drying / Coating</div>
              </div>
              <div class="issue-card" onclick="startDiagnosis('scratches')">
                <div class="title">Scratches</div><div class="sub">Print / Blanket</div>
              </div>
              <div class="issue-card" onclick="startDiagnosis('uniformity')">
                <div class="title">Uniformity</div><div class="sub">Density / Bands</div>
              </div>
              <div class="issue-card" onclick="startDiagnosis('jetting')">
                <div class="title">Jetting</div><div class="sub">Nozzles / Missing</div>
              </div>
              <div class="issue-card" onclick="startDiagnosis('transfer')">
                <div class="title">Transfer</div><div class="sub">Media / Adhesion</div>
              </div>
            </div>
          </div>

          <!-- Step 1 – SetOff branching -->
          <div id="diagStep1" class="panel hidden" style="margin-top:10px">
            <h3 style="margin:0 0 6px">Problem: <span id="issueName" style="color:var(--accent)">—</span></h3>
            <div class="help">Print same job <b>with</b> & <b>without coating</b> and examine drying. Select what you observe:</div>

            <div class="inline" style="justify-content:flex-end;margin:6px 0 10px">
              <button class="btn small" type="button" onclick="backToIssueSelect()">← Change issue</button>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
              <button class="btn" onclick="selectBranch('drying')">Job without coating is NOT properly dried</button>
              <button class="btn" onclick="selectBranch('coating')">Job with coating is NOT properly dried</button>
              <button class="btn" onclick="selectBranch('both')">Both samples are NOT properly dried</button>
            </div>
          </div>

          <!-- Step 2 – Tabs / Checklists -->
          <div id="diagStep2" class="panel hidden" style="margin-top:14px">
            <div class="rca-bar">
              <div class="rca-tabs" id="rcaTabs"></div>
              <div class="inline" style="display:flex; gap:8px; align-items:center">
                <input id="rcaSearch" class="input" placeholder="Search checks…" style="min-width:200px">
                <button class="btn small" onclick="rcaApplySearch()">Filter</button>
                <button class="btn small ghost" onclick="rcaClearSearch()">Clear</button>
                <button class="btn small" onclick="rcaMarkAll()">Mark All</button>
                <button class="btn small primary" onclick="rcaGoSummary()">Generate Summary</button>
              </div>
            </div>
            <div id="rcaList" style="margin-top:12px"></div>
          </div>

          <!-- Step 3 – Summary -->
          <div id="diagSummary" class="panel hidden" style="margin-top:14px"></div>
        </div>
      </section>

      <section id="page-settings" class="page hidden">
        <div class="panel"><h2 style="margin:0 0 10px">Settings</h2><div class="help">Coming soon…</div></div>
      </section>
    </main>
  </div>

  <div class="fab" id="fabNew"><button class="btn primary" onclick="go('create')">+ New Case</button></div>

  <div class="modal-back" id="modalBack">
    <div class="modal" id="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
        <div class="title" id="modalTitle">Case</div>
        <button class="btn small danger" onclick="closeModal()">Close</button>
      </div>
      <div id="modalBody" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ========= DATA (converted from SetOff Check List.xlsx) ========= */
const SET_OFF_DATA = {
  issue: "SetOff",
  subsystems: {
    "IPS": [
      {"check":"Ink Viscocity Messurments","spec":["K AD21 - 7.2-8.2","K AO21/22 - 7.4-8.4"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Ink Type","spec":["V2 Or V3"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Ink Expiray Date","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""}
    ],
    "BCU": [
      {"check":"NPD Mechanical/Pressure","spec":[],"roles":{"operator":false,"advanced_operator":false,"fse_expert":true},"impact":""}
    ],
    "IRD": [
      {"check":"Lamps Power","spec":["50-100%"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Fans","spec":["60-100%"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"IPU 1","spec":["~25"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"IPU 2-7","spec":["~15"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Lamps Visual Validation (both coils working each lamp)","spec":["2 Coils Activated Each Lamp"],"roles":{"operator":false,"advanced_operator":true,"fse_expert":true},"impact":""}
    ],
    "ICS": [
      {"check":"Coating Viscosity / Level / Pump","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Applicator Alignment","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"UV Lamps Operational","spec":[],"roles":{"operator":false,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Correct Coating Profile","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""}
    ],
    "Powder": [
      {"check":"Powder System Settings","spec":["Coating / Powder recipe as job spec"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Powder Quality / Flow","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Powder Coverage Pattern","spec":[],"roles":{"operator":false,"advanced_operator":true,"fse_expert":true},"impact":""}
    ],
    "BCS": [
      {"check":"Back Cylinder Speed / Registration","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Cooling / Ventilation around BCS","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Surface Cleanliness","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""}
    ],
    "STS": [
      {"check":"Paper Transport Speed","spec":["As job spec / media spec"],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Nip / Pressure","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Offset between sheets","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""},
      {"check":"Dancer behavior","spec":[],"roles":{"operator":true,"advanced_operator":true,"fse_expert":true},"impact":""}
    ],
    "DFE": [
      {"check":"Color Profile / Ink Limits","spec":[],"roles":{"operator":false,"advanced_operator":false,"fse_expert":true},"impact":""}
    ]
  }
};

/* Map which subsystems to show per branch */
const BRANCH_MAP = {
  drying:  ["IRD","STS","Powder"],
  coating: ["ICS","BCS"],
  both:    ["IPS","BCU","IRD","ICS","Powder","BCS","STS","DFE"]
};

/* ========= Storage ========= */
const LS_KEY='landa_cases_v13';
function getCases(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return [] } }
function setCases(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); updateKPIs(); }

/* ========= Routing ========= */
const pages=['dashboard','create','cases','diagnosis','settings'];
const fabNew=document.getElementById('fabNew');
function go(route){
  pages.forEach(p=>document.getElementById('page-'+p).classList.add('hidden'));
  const tgt=document.getElementById('page-'+route); if(tgt) tgt.classList.remove('hidden');
  document.querySelectorAll('.nav .item').forEach(a=>a.classList.toggle('active', a.dataset.route===route));
  if(route==='dashboard') updateKPIs();
  if(route==='cases') renderCases();
  if(fabNew) fabNew.style.display = (route==='create') ? 'none' : 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}
document.getElementById('logoHome').addEventListener('click', ()=> go('dashboard'));
document.querySelectorAll('.nav .item').forEach(a=>{
  const r=a.getAttribute('data-route');
  if(r){ a.addEventListener('click', (e)=>{ e.preventDefault(); go(r); if (document.body.classList.contains('aside-open')) document.body.classList.remove('aside-open'); }); }
});
const btnMenu=document.getElementById('btnMenu');
if(btnMenu) btnMenu.addEventListener('click', ()=> document.body.classList.toggle('aside-open'));

/* ========= Auth ========= */
const AUTH_KEY='landaAuth';
const loginPage=document.getElementById('loginPage');
const appRoot=document.getElementById('appRoot');
function showApp(){ loginPage.classList.add('hidden'); appRoot.classList.remove('hidden'); go('dashboard'); updateKPIs(); }
function showLogin(){ appRoot.classList.add('hidden'); loginPage.classList.remove('hidden'); }
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const u=document.getElementById('authUser').value.trim();
  const p=document.getElementById('authPass').value.trim();
  if(u==='Expert' && p==='Landa123456'){
    toast('Welcome, Expert','ok'); localStorage.setItem(AUTH_KEY,'true'); setTimeout(showApp, 650);
  }else{ toast('Invalid credentials','err'); }
});
if(localStorage.getItem(AUTH_KEY)==='true'){ showApp(); }
document.getElementById('btnLogout').addEventListener('click', e=>{
  e.preventDefault(); toast('Logged out successfully','ok'); localStorage.removeItem(AUTH_KEY);
  document.body.classList.remove('aside-open'); setTimeout(showLogin, 650);
});

/* ========= Minimal dropdown helper (models) ========= */
function makeDropdown(container, { placeholder='Choose…', options=[], onChange=()=>{} }){
  container.classList.add('dd');
  container.innerHTML = `
    <button type="button" class="dd-btn"><span class="dd-label">${placeholder}</span></button>
    <span class="dd-arrow" aria-hidden="true"></span>
    <div class="dd-list"></div>
    <input type="hidden" class="dd-value" value="">
  `;
  const btn = container.querySelector('.dd-btn');
  const list = container.querySelector('.dd-list');
  const label = container.querySelector('.dd-label');
  const input = container.querySelector('.dd-value');
  let state = { open:false, opts:options };

  function render(){
    list.innerHTML = '';
    if(!state.opts || !state.opts.length){ list.innerHTML = `<div class="dd-empty">No options</div>`; return; }
    state.opts.forEach((o,i)=>{
      const it=document.createElement('div'); it.className='dd-item';
      it.setAttribute('data-value',o.value); it.textContent=o.label ?? o.value;
      it.addEventListener('click', ()=>{ input.value=o.value; label.textContent=o.label??o.value; onChange(o.value); container.classList.remove('open'); });
      list.appendChild(it);
    });
  }
  btn.addEventListener('click', ()=> container.classList.toggle('open'));
  window.addEventListener('click', e=>{ if(!container.contains(e.target)) container.classList.remove('open') });
  const api={ setOptions(newOpts){ state.opts=newOpts||[]; render(); input.value=''; label.textContent=placeholder; },
              value(){ return input.value } };
  render(); return api;
}

/* ========= Models / Machine type ========= */
const machineTypeChips=document.getElementById('machineTypeChips');
const hiddenType=document.getElementById('machineType');
const ddModel = makeDropdown(document.getElementById('dd-model'), { placeholder:'Choose…', options:[] });
function fillModels(kind){
  const prefix=(kind==='Duplex')?'D':'S';
  const max=(prefix==='D')?19:9;
  const opts=Array.from({length:max},(_,i)=>({value:`${prefix}${i+1}`,label:`${prefix}${i+1}`}));
  ddModel.setOptions(opts);
}
fillModels('Simplex');
machineTypeChips.addEventListener('click', (e)=>{
  const chip=e.target.closest('.chip'); if(!chip) return;
  machineTypeChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active'); hiddenType.value=chip.dataset.type; fillModels(hiddenType.value);
});

/* ========= Troubleshooting steps (create case) ========= */
const tsSteps=document.getElementById('tsSteps');
function addStep(val=''){
  const row=document.createElement('div'); row.className='inline'; row.style.margin='6px 0';
  const inp=document.createElement('input'); inp.className='input'; inp.placeholder='Describe a step…'; inp.value=val; inp.style.flex='1';
  const rm=document.createElement('button'); rm.className='btn small danger'; rm.type='button'; rm.textContent='Remove'; rm.onclick=()=>row.remove();
  row.appendChild(inp); row.appendChild(rm); tsSteps.appendChild(row);
}
addStep('Check connections and sensors');
addStep('Verify model-specific settings');

/* ========= Files/Cases/CSV — same logic trimmed for brevity ========= */
function saveCase(e){
  e.preventDefault();
  const data={
    sfCase:val('sfCase'),
    tfsNumber:'', machineType:val('machineType'), model:ddModel.value(),
    softwareVersion: val('softwareVersion'),
    issueSummary: val('issueSummary'),
    symptoms: val('symptoms'),
    troubleshooting: collectSteps(),
    solution: val('solution'),
    attachments: [], createdAt: new Date().toISOString(), author:'Expert'
  };
  const need=['sfCase','model','issueSummary','solution'].filter(k=>!String(data[k]||'').trim());
  if(need.length){ toast('Please fill required: '+need.join(', '),'err'); return; }
  const arr=getCases(); arr.push(data); setCases(arr);
  document.getElementById('caseForm').reset(); fillModels('Simplex'); tsSteps.innerHTML=''; addStep('Check connections and sensors'); addStep('Verify model-specific settings');
  toast('Case saved successfully','ok'); go('cases');
}
function collectSteps(){ return [...tsSteps.querySelectorAll('.inline input')].map(i=>i.value).filter(v=>String(v).trim()).join('\n') }
function val(id){ const el=document.getElementById(id); return el?el.value:'' }
function renderCases(){
  const list=document.getElementById('casesList');
  const q=(document.getElementById('searchBox').value||'').toLowerCase();
  const arr=getCases().filter(c=> !q || (c.issueSummary||'').toLowerCase().includes(q) || (c.model||'').toLowerCase().includes(q) );
  const badge=document.getElementById('casesCount'); if(badge) badge.textContent=String(arr.length);
  list.innerHTML = arr.length ? arr.map((c,i)=>caseCard(c,i)).join('') : '<div class="panel">No cases yet.</div>';
}
function caseCard(c,i){
  return `<div class="case-card">
    <div class="stripe"></div>
    <div>
      <div class="title">#${i+1} — ${esc(c.sfCase||'')}</div>
      <div class="meta"><span class="kv"><span class="k">Model:</span><span class="v">${esc(c.model||'')} (${esc(c.machineType||'')})</span></span></div>
      <div class="kv" style="margin-top:8px"><span class="k">Issue:</span><span class="v">${esc(c.issueSummary||'')}</span></div>
    </div>
    <div class="actions"><button class="btn small" onclick="openCase(${i})">Details</button></div>
  </div>`;
}
function openCase(i){
  const c=getCases()[i]; if(!c) return; document.getElementById('modalTitle').textContent=`Case #${i+1} — ${c.sfCase||''}`;
  document.getElementById('modalBody').innerHTML = `
    <div class="panel" style="margin-top:12px"><h3>Problem</h3>
      <div class="kv"><span class="k">Summary:</span><span class="v">${esc(c.issueSummary||'')}</span></div>
      <div class="kv"><span class="k">Symptoms:</span><span class="v">${nl(esc(c.symptoms||''))}</span></div>
      <div class="kv"><span class="k">Troubleshooting:</span><span class="v">${nl(esc(c.troubleshooting||''))}</span></div>
      <div class="kv"><span class="k">Solution:</span><span class="v">${nl(esc(c.solution||''))}</span></div>
    </div>`;
  openModal();
}
function exportCSV(){
  const arr=getCases();
  const cols=['sfCase','machineType','model','softwareVersion','issueSummary','symptoms','troubleshooting','solution','createdAt','author'];
  const csv=[cols.join(',')].concat(arr.map(o=> cols.map(k=> JSON.stringify((o[k]||'').toString().replace(/\n/g,' '))).join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='landa_cases.csv'; a.click();
}
function updateKPIs(){
  const arr=getCases(); byId('kpiTotal').textContent=arr.length;
  byId('kpiFiles').textContent=arr.filter(c=>Array.isArray(c.attachments)&&c.attachments.length).length;
  byId('kpiUpdated').textContent=arr.length? new Date(arr[arr.length-1].createdAt).toLocaleString() : '—';
  const pageCasesCount=document.getElementById('casesCount'); if(pageCasesCount) pageCasesCount.textContent=String(arr.length);
}

/* ========= Particles & utils ========= */
(function(){
  const c=document.getElementById('particles'); if(!c) return; const ctx=c.getContext('2d'); let w,h;
  function resize(){ w=c.width=innerWidth; h=c.height=innerHeight; }
  addEventListener('resize',resize); resize();
  const dots=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.6+0.6,vx:(Math.random()-.5)*0.28,vy:(Math.random()-.5)*0.28}));
  function step(){
    ctx.clearRect(0,0,w,h);
    for(const d of dots){
      d.x+=d.vx; d.y+=d.vy;
      if(d.x<0||d.x>w) d.vx*=-1; if(d.y<0||d>h) d.vy*=-1;
      ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
      ctx.fillStyle='rgba(59,208,255,0.25)'; ctx.fill();
    }
    requestAnimationFrame(step);
  }
  step();
})();

function byId(id){ return document.getElementById(id) }
function toast(msg,type='ok'){ const t=document.createElement('div'); t.className='toast '+type; t.textContent=msg; const w=byId('toasts'); w.appendChild(t); setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),250)},1600); }
function esc(s){ return (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) } function nl(s){ return String(s||'').replace(/\n/g,'<br>') }
function openModal(){ byId('modalBack').style.display='flex' } function closeModal(){ byId('modalBack').style.display='none' }

/* ========= RCA Logic ========= */
const RCA_LS_PREFIX = 'landa_rca_';
function startDiagnosis(type){
  localStorage.setItem('landa_diag_issue', type);
  byId('diagSelect').classList.add('hidden');
  byId('diagStep1').classList.remove('hidden');

  const issueMap = { setoff:'SetOff', scratches:'Scratches', uniformity:'Uniformity', jetting:'Jetting', transfer:'Transfer' };
  byId('issueName').textContent = issueMap[type] || 'General';

  // reset next steps
  byId('diagStep2').classList.add('hidden');
  byId('diagSummary').classList.add('hidden');
  setStepActive(1);
}
function backToIssueSelect(){
  localStorage.removeItem('landa_diag_issue');
  localStorage.removeItem('landa_diag_branch');
  byId('diagStep1').classList.add('hidden');
  byId('diagStep2').classList.add('hidden');
  byId('diagSummary').classList.add('hidden');
  byId('diagSelect').classList.remove('hidden');
  setStepActive(0);
}
function setStepActive(n){
  [1,2,3,4].forEach((i,idx)=>{
    byId('rcaStep'+i)?.classList.toggle('active', (idx===n));
  });
}
function selectBranch(branch){
  localStorage.setItem('landa_diag_branch', branch);
  // build tabs
  const tabsWrap = byId('rcaTabs');
  tabsWrap.innerHTML='';
  const subs = (BRANCH_MAP[branch]||[]);
  subs.forEach((s,idx)=>{
    const el=document.createElement('div');
    el.className='rca-tab'+(idx===0?' active':'');
    el.textContent=s;
    el.dataset.sub=s;
    el.onclick=()=>switchTab(s);
    tabsWrap.appendChild(el);
  });
  byId('rcaList').innerHTML='';
  if(subs.length){ renderSubSystem(subs[0]); }
  byId('diagStep2').classList.remove('hidden');
  byId('diagSummary').classList.add('hidden');
  setStepActive(2);
  byId('diagStep1').scrollIntoView({behavior:'smooth', block:'start'});
}
function switchTab(sub){
  document.querySelectorAll('.rca-tab').forEach(t=>t.classList.toggle('active', t.dataset.sub===sub));
  renderSubSystem(sub);
}
function rcaApplySearch(){ renderSubSystem(currentSub()); }
function rcaClearSearch(){ byId('rcaSearch').value=''; renderSubSystem(currentSub()); }
function rcaMarkAll(){
  const wrap=byId('rcaList');
  wrap.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked=true; saveRowState(cb) });
  toast('All checks marked','ok');
}
function currentSub(){ const t=document.querySelector('.rca-tab.active'); return t?t.dataset.sub:''; }

function renderSubSystem(sub){
  const list=byId('rcaList'); const q=(byId('rcaSearch').value||'').toLowerCase().trim();
  const arr = (SET_OFF_DATA.subsystems[sub]||[]).map((row,idx)=>({...row,_idx:idx}));
  const filtered = q? arr.filter(r=> r.check.toLowerCase().includes(q) || (r.spec||[]).join(' ').toLowerCase().includes(q) ) : arr;

  list.innerHTML = filtered.map(row=> rcaRow(sub,row)).join('') || '<div class="panel">No checks found.</div>';

  // re-bind events
  filtered.forEach(row=>{
    const cb=byId(rcaId(sub,row._idx,'cb'));
    const inp=byId(rcaId(sub,row._idx,'actual'));
    cb.addEventListener('change', ()=>saveRowState(cb));
    inp.addEventListener('input', ()=>updateDeviation(sub,row._idx));
    // load saved state
    const mem = loadRowState(sub,row._idx);
    if(mem){ cb.checked=!!mem.done; inp.value=mem.actual??''; updateDeviation(sub,row._idx); }
  });
}
function rcaRow(sub,row){
  const specText = (row.spec||[]).join(' | ');
  const roles = row.roles||{};
  return `
  <div class="rca-row">
    <div style="display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:center">
      <label style="display:flex;align-items:center;gap:10px;flex:1;min-width:260px">
        <input id="${rcaId(sub,row._idx,'cb')}" type="checkbox">
        <div>
          <div style="font-weight:600;opacity:.95">${esc(row.check)}</div>
          ${specText?`<div class="spec-pill" title="Spec target">${esc(specText)}</div>`:`<div class="spec-pill dim">No explicit spec</div>`}
          <div class="role-badges" style="margin-top:6px">
            ${roles.operator?`<span class="role op">Operator</span>`:''}
            ${roles.advanced_operator?`<span class="role adv">Adv. Operator</span>`:''}
            ${roles.fse_expert?`<span class="role fse">FSE / Expert</span>`:''}
          </div>
        </div>
      </label>
      <div class="rca-spec" style="flex:1">
        <div><small class="k">Target</small><div class="spec-pill">${specText||'—'}</div></div>
        <div>
          <label class="k" for="${rcaId(sub,row._idx,'actual')}">Actual</label>
          <input id="${rcaId(sub,row._idx,'actual')}" class="input" placeholder="${specInputPlaceholder(row.spec)}">
        </div>
        <div>
          <div class="k">Deviation</div>
          <div id="${rcaId(sub,row._idx,'dev')}" class="dev-pill dev-na">—</div>
        </div>
      </div>
    </div>
  </div>`;
}
function rcaId(sub,idx,suffix){ return `rca_${sub}_${idx}_${suffix}`; }

/* SPEC Parsing & Deviation */
function specInputPlaceholder(specArr){
  const s=(specArr||[]).join(' ');
  if(/~\s*\d+(\.\d+)?/.test(s)) return '≈ value';
  if(/\d+(\.\d+)?\s*-\s*\d+(\.\d+)?/.test(s)) return 'number in range';
  if(/\d+%/.test(s)) return '% value';
  return 'value';
}
function parseSpec(specArr){
  const s=(specArr||[]).join(' ');
  // Range: 7.2-8.2
  const mRange = s.match(/(\d+(\.\d+)?)\s*-\s*(\d+(\.\d+)?)/);
  if(mRange){
    return {type:'range', min:parseFloat(mRange[1]), max:parseFloat(mRange[3])};
  }
  // Approx: ~25  (use ±10% tolerance)
  const mApprox = s.match(/~\s*(\d+(\.\d+)?)/);
  if(mApprox){
    const val = parseFloat(mApprox[1]); const tol = val*0.10;
    return {type:'approx', target:val, min:val-tol, max:val+tol};
  }
  // Percentage range like 60-100%
  const mPerc = s.match(/(\d+(\.\d+)?)\s*-\s*(\d+(\.\d+)?)\s*%/);
  if(mPerc){
    return {type:'range', min:parseFloat(mPerc[1]), max:parseFloat(mPerc[3])};
  }
  return {type:'text'}; // free text / not numeric
}
function updateDeviation(sub,idx){
  const row = (SET_OFF_DATA.subsystems[sub]||[])[idx]; if(!row) return;
  const spec = parseSpec(row.spec||[]);
  const actualStr = byId(rcaId(sub,idx,'actual')).value.trim();
  const devEl = byId(rcaId(sub,idx,'dev'));
  if(!actualStr){ devEl.className='dev-pill dev-na'; devEl.textContent='—'; return; }

  let num = parseFloat(actualStr.replace('%',''));
  if(isNaN(num)){ devEl.className='dev-pill dev-na'; devEl.textContent='N/A'; return; }

  if(spec.type==='range' || spec.type==='approx'){
    if(num>=spec.min && num<=spec.max){
      devEl.className='dev-pill dev-ok';
      devEl.textContent='Within spec';
    }else{
      const d = (num < spec.min) ? (num - spec.min) : (num - spec.max);
      devEl.className='dev-pill dev-err';
      devEl.textContent = `Out of spec (${d.toFixed(2)})`;
    }
  }else{
    devEl.className='dev-pill dev-na';
    devEl.textContent='—';
  }
  saveRowState(byId(rcaId(sub,idx,'cb'))); // persist actual too
}
function saveRowState(cb){
  const [_,sub,idx] = cb.id.split('_'); // rca_SUB_IDX_cb
  const actual = byId(rcaId(sub,idx,'actual')).value;
  const key = RCA_LS_PREFIX+sub+'_'+idx;
  localStorage.setItem(key, JSON.stringify({done: cb.checked, actual}));
}
function loadRowState(sub,idx){
  const key = RCA_LS_PREFIX+sub+'_'+idx;
  try{ return JSON.parse(localStorage.getItem(key)||''); }catch(e){ return null }
}

/* Summary */
function rcaGoSummary(){
  const branch = localStorage.getItem('landa_diag_branch')||'both';
  const subs = BRANCH_MAP[branch]||[];
  const out = [];
  subs.forEach(sub=>{
    const rows = SET_OFF_DATA.subsystems[sub]||[];
    const issues=[];
    rows.forEach((row,idx)=>{
      const mem = loadRowState(sub,idx)||{};
      let status='pending';
      // compute deviation
      let dev='—', bad=false;
      const spec = parseSpec(row.spec||[]);
      if(mem.actual && (spec.type==='range' || spec.type==='approx')){
        const num=parseFloat(String(mem.actual).replace('%',''));
        if(!isNaN(num)){
          if(num>=spec.min && num<=spec.max){ dev='OK'; }
          else { dev='Out of spec'; bad=true; }
        }
      }
      if(mem.done && !bad){ status='ok'; }
      else if(bad){ status='deviation'; }
      else { status='pending'; }
      if(status!=='ok'){
        issues.push({idx, check:row.check, spec:(row.spec||[]).join(' | '), actual:mem.actual||'', status, sub});
      }
    });
    if(issues.length) out.push({sub, issues});
  });

  const wrap=byId('diagSummary');
  if(!out.length){
    wrap.innerHTML = `<div class="badge ok">All checks confirmed within spec ✅</div>`;
  }else{
    wrap.innerHTML = `
      <h3 style="margin:0 0 8px">Summary & Recommendations</h3>
      ${out.map(block=>`
        <div class="panel" style="margin-top:10px">
          <div class="title" style="font-weight:700">${block.sub}</div>
          ${block.issues.map(it=>`
            <div class="kv" style="margin-top:6px">
              <span class="k">• ${esc(it.check)}</span>
              <span class="v">[${it.status==='deviation'?'Deviation ❗':'Pending'}] ${it.spec?`Target: ${esc(it.spec)}; `:''}Actual: ${esc(it.actual||'—')}</span>
            </div>`).join('')}
        </div>
      `).join('')}
      <div class="panel" style="margin-top:12px">
        <div class="title">Auto-suggestions</div>
        <ul style="margin:8px 0 0 18px; line-height:1.6">
          <li>If IRD values are out-of-spec → increase lamp power/fan as per job spec and recheck IPU.</li>
          <li>If coating path selected → verify UV lamp status and applicator alignment; re-run coating profile.</li>
          <li>High setoff despite drying OK → check ink viscosity and ink type (V2/V3) and expiry in IPS.</li>
          <li>Persistent issues → escalate to FSE (see rows with FSE badge).</li>
        </ul>
      </div>
    `;
  }
  wrap.classList.remove('hidden');
  setStepActive(3);
  wrap.scrollIntoView({behavior:'smooth', block:'start'});
}

/* Helpers to restore state if coming back */
function loadDiagnosis(){
  const issue = localStorage.getItem('landa_diag_issue');
  if(!issue){ return; }
  byId('diagSelect').classList.add('hidden');
  byId('diagStep1').classList.remove('hidden');
  byId('issueName').textContent = (issue==='setoff'?'SetOff':'General');

  const branch = localStorage.getItem('landa_diag_branch');
  if(branch){
    selectBranch(branch);
  }
}
loadDiagnosis();
go('dashboard');
</script>
</body>
</html>
