<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Landa Quantum – Troubleshoot Suite (V18.8-Dynamic)</title>

<link rel="icon" type="image/svg+xml"
  href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect x='2' y='2' width='36' height='36' rx='8' fill='%23000000' opacity='0.85' stroke='%23ffffff10'/%3E%3Ccircle cx='20' cy='20' r='8' fill='%2300aeef'/%3E%3C/svg%3E">

<style>
:root{
  --bg:#0b1016; --bg2:#0e1420; --panel:rgba(18,24,34,.6); --glass:rgba(22,30,45,.55);
  --text:#e8f0ff; --muted:#9bb0d0; --border:rgba(255,255,255,.08);
  --accent:#00aeef; --accent2:#3bd0ff; --ok:#4ade80; --err:#ff4967;
  --header:56px; --aside-w:260px; --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font:14px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(0,174,239,.18), transparent 60%),
    radial-gradient(1000px 500px at 110% 10%, rgba(59,208,255,.15), transparent 55%),
    linear-gradient(180deg, var(--bg), var(--bg2) 60%, #0a0f15);
  animation: breathe 14s ease-in-out infinite;
  overflow:hidden;
}
@keyframes breathe{0%,100%{filter:brightness(1) saturate(1)}50%{filter:brightness(1.07) saturate(1.06)}}
.hidden{display:none!important}

/* Panels/Buttons */
.panel{
  border:1px solid var(--border); border-radius:var(--radius); padding:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  box-shadow:0 18px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
  backdrop-filter:blur(14px) saturate(1.08);
  transition:box-shadow .25s, transform .25s, border-color .25s;
}
.panel:hover{ box-shadow:0 20px 46px rgba(0,174,239,.24), inset 0 0 0 1px rgba(59,208,255,.12); border-color:rgba(59,208,255,.35); transform:translateY(-1px) }
.btn{
  border:1px solid var(--border); color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  padding:10px 14px; border-radius:12px; cursor:pointer;
  transition:.18s transform,.18s box-shadow,.18s border-color;
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 16px 38px rgba(0,0,0,.36); border-color:rgba(59,208,255,.45) }
.btn.primary{ border-color:var(--accent); background:linear-gradient(180deg, rgba(0,174,239,.28), rgba(0,174,239,.08)); color:#fff }
.btn.ghost{ background:transparent }
.btn.small{ padding:6px 10px; border-radius:9px; font-size:12.5px }
.btn.danger{ border-color:rgba(255,73,103,.5); color:#fff }

.toast-wrap{ position:fixed; right:16px; top:calc(var(--header) + 8px); display:flex; flex-direction:column; gap:8px; z-index:110 }
.toast{ padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(20,26,38,.85); box-shadow:0 14px 28px rgba(0,0,0,.35) }
.toast.ok{ border-color:rgba(74,222,128,.5) } .toast.err{ border-color:rgba(255,73,103,.55) }
#particles{ position:fixed; inset:0; z-index:-1; pointer-events:none }

/* Login */
#loginPage{ display:flex; align-items:center; justify-content:center; min-height:100vh; padding:24px }
.auth{ width:min(460px, 92vw) }
.logo{ display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:14px }
.logo svg{ height:80px; filter:drop-shadow(0 0 16px rgba(0,174,239,.4)); animation:pulse 2.8s ease-in-out infinite }
.logo .subtitle{ color:var(--muted); font-size:12.5px; letter-spacing:.6px }
@keyframes pulse{0%{filter:drop-shadow(0 0 0 rgba(0,174,239,0))}50%{filter:drop-shadow(0 0 18px rgba(0,174,239,.45))}100%{filter:drop-shadow(0 0 0 rgba(0,174,239,0))}}
.auth h2{ margin:0 0 6px; font-size:18px; letter-spacing:.5px; opacity:.92; text-align:center }
.label{ display:block; color:var(--muted); margin:6px 2px 6px }
.input{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015)); outline:none }
.btn.full{ width:100%; margin-top:14px }

/* App Layout */
.header{
  position:sticky; top:0; z-index:100;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  height:var(--header); padding:8px 14px;
  background:linear-gradient(180deg, rgba(10,14,20,.82), rgba(10,14,20,.34));
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(10px) saturate(1.1);
  box-shadow:0 4px 14px rgba(0,0,0,.35);
}
.header-left{ display:flex; align-items:center; gap:10px; min-width:0 }
.header-title{ display:flex; align-items:center; gap:10px; min-width:0 }
.header-title h1{ font-size:16px; letter-spacing:.4px; margin:0; opacity:.95; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.header .badge-env{ font-size:11px; color:#9bb0d0; border:1px solid var(--border); padding:2px 8px; border-radius:999px }
.header .logo-mini svg{ width:28px; height:28px; animation:pulseGlow 3.2s ease-in-out infinite; transform-origin:center }
@keyframes pulseGlow{0%{filter:drop-shadow(0 0 0 rgba(0,174,239,0));transform:scale(1)}50%{filter:drop-shadow(0 0 12px rgba(0,174,239,.45));transform:scale(1.05)}100%{filter:drop-shadow(0 0 0 rgba(0,174,239,0));transform:scale(1)}}
.header .menu-btn{ display:none; gap:8px; align-items:center }
.header .menu-btn .bar{ width:18px; height:2px; background:#cfe7ff; border-radius:2px; box-shadow:0 0 8px rgba(0,174,239,.35) }

.wrap{ display:grid; grid-template-columns:var(--aside-w) 1fr; height:calc(100vh - var(--header)) }
.aside{
  border-right:1px solid var(--border);
  background:linear-gradient(180deg, rgba(14,20,30,.6), rgba(14,20,30,.25));
  backdrop-filter:blur(8px); padding:16px 14px;
  position:sticky; top:var(--header); height:calc(100vh - var(--header));
  overflow:auto; z-index:10;
}
.main{ padding:16px 16px 60px; overflow:auto }

.nav{display:flex; flex-direction:column; gap:8px}
.nav .item{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border-radius:10px; text-decoration:none; color:var(--text); opacity:.85;
  transition:.18s transform,.18s box-shadow,.18s border-color;
}
.nav .item:hover{ transform:translateY(-1px); box-shadow:0 14px 30px rgba(0,0,0,.35); border-color:rgba(59,208,255,.35); opacity:1}
.nav .item.active{ border-color:var(--accent); box-shadow:0 0 0 1px inset rgba(59,208,255,.25), 0 12px 28px rgba(0,174,239,.25)}
.nav .badge{ margin-left:auto; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted)}

.grid{display:grid; gap:12px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
@media (max-width:1100px){ .grid.cols-3{grid-template-columns:1fr 1fr} }
@media (max-width:780px){
  .header{padding:8px 10px}
  .header .menu-btn{display:flex}
  .header-title h1{font-size:15px; max-width:62vw}
  .wrap{grid-template-columns:1fr}
  .aside{position:fixed; top:var(--header); left:0; bottom:0; height:auto; width:min(82vw,320px);
         transform:translateX(-105%); transition:transform .25s ease; box-shadow:16px 0 40px rgba(0,0,0,.45); z-index:120}
  body.aside-open .aside{transform:translateX(0)}
  .main{padding:14px 12px 72px}
  .grid.cols-2,.grid.cols-3{grid-template-columns:1fr}
}

/* Form controls */
.label.v13{display:block; color:var(--muted); margin:6px 2px 6px}
.input.v13, textarea, .file{
  width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)); outline:none;
}
textarea{ min-height:84px; resize:vertical }

/* OCD sizing */
.field-sf{ max-width: 180px }
.field-model{ max-width: 130px }
.field-system{ max-width: 240px }
.field-subsystem{ max-width: 260px }
.field-category{ max-width: 220px }
.field-item{ max-width: 260px }
.field-sw{ max-width: 160px }
.field-troubles{ max-width: 520px }
.fit-inline{ display:inline-flex; gap:10px; align-items:center; flex-wrap:wrap }

/* Chips */
.chips{display:flex; gap:8px; flex-wrap:wrap}
.chip{
  padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
}
.chip.active{ background:linear-gradient(180deg, rgba(0,174,239,.28), rgba(0,174,239,.08)); border-color:rgba(0,174,239,.55) }

/* ===== Custom Glass Dropdown ===== */
.dd{ position:relative; display:inline-block; width:100%; max-width:100% }
.dd-btn{
  width:100%; padding:10px 38px 10px 12px; border:1px solid var(--border); border-radius:10px;
  color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
  backdrop-filter:blur(10px);
  text-align:left; cursor:pointer;
  transition:border-color .18s, box-shadow .18s, transform .18s;
}
.dd-btn:hover{ transform:translateY(-1px); box-shadow:0 16px 38px rgba(0,0,0,.28); border-color:rgba(59,208,255,.35) }
.dd-btn:focus{ outline:none; border-color:rgba(59,208,255,.45); box-shadow:0 0 0 3px rgba(59,208,255,.18) }
.dd-arrow{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  width:16px; height:16px; pointer-events:none; opacity:.9;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23bfe9ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") center/16px 16px no-repeat;
  filter:drop-shadow(0 0 6px rgba(0,174,239,.35));
}
.dd-list{
  position:absolute; left:0; right:0; top:calc(100% + 6px);
  border:1px solid var(--border); border-radius:12px;
  background:linear-gradient(180deg, rgba(18,24,34,.96), rgba(18,24,34,.88));
  backdrop-filter:blur(12px) saturate(1.05);
  box-shadow:0 22px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03);
  max-height:260px; overflow:auto; padding:6px 0; display:none; z-index:30;
}
.dd.open .dd-list{ display:block }
.dd-item{
  padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px;
  transition:background .12s, transform .12s, color .12s;
}
.dd-item:hover{ background:rgba(59,208,255,.12) }
.dd-item[aria-selected="true"]::before{
  content:""; width:8px; height:8px; border-radius:2px; background:linear-gradient(180deg, var(--accent), var(--accent2));
  box-shadow:0 0 12px rgba(0,174,239,.5);
}
.dd-empty{ padding:8px 12px; color:var(--muted) }
.dd.disabled .dd-btn{ opacity:.6; pointer-events:none }
.dd-list::-webkit-scrollbar{ width:10px }
.dd-list::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.08); border:3px solid transparent; border-radius:10px; background-clip:padding-box }
.dd-list::-webkit-scrollbar-thumb:hover{ background:rgba(59,208,255,.4); border-color:transparent }

  /* Issue selection cards */
.issue-grid{display:flex;flex-wrap:wrap;gap:12px}
.issue-card{
  flex:1 1 180px; min-width:180px; max-width:260px;
  padding:14px; border:1px solid var(--border); border-radius:14px; cursor:pointer;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
  box-shadow:0 10px 26px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.03);
  transition:.2s;
}
.issue-card:hover{ transform:translateY(-2px); border-color:rgba(59,208,255,.45); box-shadow:0 18px 40px rgba(0,174,239,.28) }
.issue-card .title{font-weight:600;margin-bottom:6px}
.issue-card .sub{color:var(--muted);font-size:12.5px}

/* Cards/Modal/FAB */
.fab{ position:fixed; left:14px; bottom:18px; z-index:60 }
.fab .btn{ padding:14px 16px; border-radius:20px; font-weight:600; box-shadow:0 18px 40px rgba(0,174,239,.35)}
.case-card{ border:1px solid var(--border); border-radius:14px; padding:14px; display:grid; grid-template-columns:auto 1fr auto; gap:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); box-shadow:0 14px 34px rgba(0,0,0,.32), inset 0 0 0 1px rgba(255,255,255,.03); transition:.25s}
.case-card:hover{ box-shadow:0 18px 40px rgba(0,174,239,.2), inset 0 0 0 1px rgba(59,208,255,.12); border-color:rgba(59,208,255,.35); transform:translateY(-1px) }
.case-card .stripe{ width:6px; border-radius:8px; background:linear-gradient(180deg, var(--accent), var(--accent2)) }
.case-card .title{ font-weight:600; opacity:.95 } .case-card .meta{ color:var(--muted); font-size:12.5px; display:flex; gap:10px; flex-wrap:wrap }
.case-card .actions{ display:flex; gap:8px; align-items:center } .case-card .files{ color:var(--muted) }
.kv{ display:flex; gap:6px } .k{color:var(--muted)} .v{color:var(--text)}

.modal-back{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:140 }
.modal{
  width:min(880px, 94vw); max-height:88vh; overflow:auto; border:1px solid var(--border); border-radius:16px; padding:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025)); box-shadow:0 30px 80px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03);
  animation:pop .22s ease;
}
@keyframes pop{from{transform:translateY(8px) scale(.98); opacity:0}to{transform:translateY(0) scale(1); opacity:1}}
</style>
</head>

<body>
<canvas id="particles"></canvas>
<div class="toast-wrap" id="toasts"></div>

<!-- LOGIN -->
<section id="loginPage">
  <div class="auth panel center">
    <div class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 110" aria-label="Landa Digital Printing">
        <defs>
          <linearGradient id="lg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00aeef"/><stop offset="100%" stop-color="#3bd0ff"/></linearGradient>
          <filter id="g" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <text x="50%" y="50%" text-anchor="middle" fill="url(#lg)" filter="url(#g)"
              font-family="Segoe UI, Inter, system-ui, sans-serif" font-weight="700" font-size="56" letter-spacing="1">Landa</text>
        <text x="50%" y="82%" text-anchor="middle" fill="#9bb0d0"
              font-family="Segoe UI, Inter, system-ui, sans-serif" font-size="18" letter-spacing="2">Digital Printing</text>
      </svg>
      <div class="subtitle">Quantum Troubleshoot Suite</div>
    </div>
    <h2>Sign in to continue</h2>
    <label class="label" for="authUser">Username</label>
    <input class="input" id="authUser" placeholder="Expert" autocomplete="username">
    <label class="label" for="authPass">Password</label>
    <input class="input" id="authPass" type="password" placeholder="Password" autocomplete="current-password">
    <button class="btn primary full" id="btnLogin">Login</button>
  </div>
</section>

<!-- APP -->
<div class="app hidden" id="appRoot">
  <header class="header">
    <div class="header-left">
      <button class="menu-btn btn small" id="btnMenu" aria-label="Toggle menu" title="Menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>
      <div class="header-title" id="logoHome" title="Go to Dashboard" style="cursor:pointer">
        <div class="logo-mini" aria-hidden="true">
          <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="36" height="36" rx="8" fill="rgba(0,0,0,0.78)" stroke="rgba(255,255,255,0.08)"/>
            <circle cx="20" cy="20" r="8" fill="#00aeef">
              <animate attributeName="r" values="8;9;8" dur="2.6s" repeatCount="indefinite"/>
            </circle>
          </svg>
        </div>
        <h1>Landa Quantum – Troubleshoot Suite</h1>
      </div>
    </div>
    <span class="badge-env">V18.8-Dynamic</span>
  </header>

  <div class="wrap">
    <aside class="aside" id="aside">
      <nav class="nav">
        <a class="item active" href="#" data-route="dashboard"><span>Dashboard</span></a>
        <a class="item" href="#" data-route="create"><span>Create Case</span></a>
        <a class="item" href="#" data-route="cases"><span>All Cases</span><span class="badge" id="casesCount">0</span></a>
        <a class="item" href="#" data-route="diagnosis"><span>Root Cause Analyzer</span></a>
        <a class="item" href="#" data-route="settings"><span>Settings</span></a>
        <a class="item" href="#" id="btnLogout"><span>Logout</span></a>
      </nav>
    </aside>

    <main class="main">
      <!-- Dashboard -->
      <section id="page-dashboard" class="page">
        <div class="grid cols-3">
          <div class="panel"><div class="title">Total Cases</div><div style="font-size:28px;margin-top:6px" id="kpiTotal">0</div><div class="help">All cases saved locally</div></div>
          <div class="panel"><div class="title">With Attachments</div><div style="font-size:28px;margin-top:6px" id="kpiFiles">0</div><div class="help">Cases containing files</div></div>
          <div class="panel"><div class="title">Last Updated</div><div style="font-size:28px;margin-top:6px" id="kpiUpdated">—</div><div class="help">Most recent save</div></div>
        </div>
        <div class="panel" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div class="title">Quick Actions</div>
            <div>
              <button class="btn" onclick="go('create')">+ New Case</button>
              <button class="btn" onclick="go('cases')">View All</button>
              <button class="btn" onclick="exportCSV()">Export CSV</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Create Case -->
      <section id="page-create" class="page hidden">
        <div class="panel">
          <h2 style="margin:0 0 10px">Create New Case</h2>
          <form id="caseForm" onsubmit="saveCase(event)">
            <div class="grid cols-2">

              <!-- Machine Type / Model -->
              <div>
                <label class="label v13">Machine Type *</label>
                <div class="chips" id="machineTypeChips">
                  <div class="chip active" data-type="Simplex">Simplex</div>
                  <div class="chip" data-type="Duplex">Duplex</div>
                </div>
                <input type="hidden" id="machineType" value="Simplex">
              </div>
              <div>
                <label class="label v13">Model *</label>
                <div id="dd-model" class="dd field-model"></div>
              </div>

              <!-- SF Case / Software -->
              <div>
                <label class="label v13">SF Case *</label>
                <input class="input v13 field-sf" id="sfCase" inputmode="numeric" placeholder="123456">
              </div>
              <div>
                <label class="label v13">Software Version</label>
                <input class="input v13 field-sw" id="softwareVersion" placeholder="4.2.11">
              </div>

              <!-- Dynamic hierarchy: System → Sub-System → Category → Item -->
              <div>
                <label class="label v13">System *</label>
                <div id="dd-system" class="dd field-system"></div>
              </div>

              <div id="wrap-sub" class="hidden">
                <label class="label v13">Sub-System *</label>
                <div id="dd-sub" class="dd field-subsystem"></div>
              </div>

              <div id="wrap-cat" class="hidden">
                <label class="label v13">Category *</label>
                <div id="dd-cat" class="dd field-category"></div>
              </div>

              <div id="wrap-item" class="hidden">
                <label class="label v13">Item *</label>
                <div id="dd-item" class="dd field-item"></div>
              </div>

              <!-- TFS -->
              <div class="fit-inline full">
                <div>
                  <label class="label v13">TFS</label>
                  <div class="fit-inline">
                    <input type="checkbox" id="tfsToggle" title="Enable TFS">
                    <input class="input v13 hidden" id="tfsNumber" inputmode="numeric" placeholder="TFS-12345" style="max-width:220px">
                  </div>
                </div>
              </div>

              <div class="full"><hr style="border:0; border-top:1px solid var(--border)"></div>

              <!-- Issue / Symptoms -->
              <div class="full">
                <label class="label v13">Issue Summary *</label>
                <input class="input v13" id="issueSummary" placeholder="One line summary">
              </div>
              <div class="full">
                <label class="label v13">Symptoms / Error Messages</label>
                <textarea id="symptoms" class="input v13" placeholder="Short bullets or error codes"></textarea>
              </div>

              <!-- Troubleshooting / Part -->
              <div class="full">
                <label class="label v13">Troubleshooting (steps)</label>
                <div id="tsSteps" class="field-troubles"></div>
                <button class="btn small" type="button" onclick="addStep()">+ Add step</button>
              </div>
              <div class="full">
                <label class="label v13">Part (Catalog)</label>
                <div class="partwrap field-troubles">
                  <input class="input v13" id="partInput" placeholder="Type to search part number (e.g., 12-34567)…">
                  <div class="part-suggest" id="partSuggest"></div>
                </div>
              </div>

              <!-- Solution / Verification / Notes -->
              <div class="full">
                <label class="label v13">Solution Implemented *</label>
                <textarea id="solution" class="input v13 field-troubles" placeholder="What fixed the issue"></textarea>
              </div>
              <div class="full">
                <label class="label v13">Verification Method</label>
                <input id="verification" class="input v13 field-troubles" placeholder="How did we verify the fix?">
              </div>
              <div class="full">
                <label class="label v13">Notes</label>
                <textarea id="notes" class="input v13 field-troubles" placeholder="Anything noteworthy for future cases"></textarea>
              </div>

              <!-- Attachments -->
              <div class="full">
                <label class="label v13">Attachments (multiple)</label>
                <div id="filesWrap"></div>
                <button class="btn small" type="button" onclick="addFileRow()">+ Add another file</button>
                <div class="help">Accepted: pdf, doc, xls, png, jpg, jpeg, zip</div>
              </div>

              <div class="inline full" style="margin-top:6px">
                <button class="btn primary" type="submit">Save Case</button>
                <button class="btn ghost" type="button" onclick="go('cases')">View All</button>
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- Cases -->
      <section id="page-cases" class="page hidden">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
            <h2 style="margin:0">All Cases</h2>
            <div class="inline" style="flex-wrap:wrap; gap:8px">
              <input id="searchBox" class="input v13" placeholder="Search text (Issue / Model / System)" style="min-width:220px">
              <button class="btn" onclick="renderCases()">Apply</button>
              <button class="btn" onclick="exportCSV()">Export CSV</button>
            </div>
          </div>
        </div>
        <div id="casesList" class="grid cols-1" style="margin-top:14px"></div>
      </section>

      <!-- Root Cause Analyzer -->
<section id="page-diagnosis" class="page hidden">
  <div class="panel">
    <h2 style="margin:0 0 10px">Root Cause Analyzer – Fishbone Troubleshooter</h2>
    <p class="help">Follow the guided diagnostic to identify the source of a problem step-by-step.</p>

    <div id="diagContainer">
<!-- Step 0 – Problem selection -->
<div id="diagSelect" class="panel" style="margin-top:10px">
  <h3 style="margin:0 0 10px">Select Issue to Diagnose</h3>
  <p class="help">Choose the problem type to start the guided analysis:</p>
  <div class="issue-grid">
  <div class="issue-card" onclick="startDiagnosis('setoff')">
    <div class="title">SetOff</div><div class="sub">Drying / Coating</div>
  </div>
  <div class="issue-card" onclick="startDiagnosis('scratches')">
    <div class="title">Scratches</div><div class="sub">Print / Blanket</div>
  </div>
  <div class="issue-card" onclick="startDiagnosis('uniformity')">
    <div class="title">Uniformity</div><div class="sub">Density / Bands</div>
  </div>
  <div class="issue-card" onclick="startDiagnosis('jetting')">
    <div class="title">Jetting</div><div class="sub">Nozzles / Missing</div>
  </div>
  <div class="issue-card" onclick="startDiagnosis('transfer')">
    <div class="title">Transfer</div><div class="sub">Media / Adhesion</div>
  </div>
</div>
      <!-- Step 1 -->
      <div id="diagStep1" class="panel hidden" style="margin-top:10px">
         <h3>Problem: <span id="issueName" style="color:var(--accent)">—</span></h3>
         <p>Perform a print of the same job <b>with</b> and <b>without coating</b>, then examine the drying of both samples.</p>
        <!-- back button -->
  <div class="inline" style="justify-content:flex-end;margin:6px 0 10px">
    <button class="btn small" type="button" onclick="backToIssueSelect()">← Change issue</button>
  </div>

  <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
    <button class="btn" onclick="selectDiagnosis('drying')">Job without coating is NOT properly dried</button>
    <button class="btn" onclick="selectDiagnosis('coating')">Job with coating is NOT properly dried</button>
    <button class="btn" onclick="selectDiagnosis('both')">Both samples are NOT properly dried</button>
  </div>
</div>

      <!-- Step 2 – dynamic -->
      <div id="diagStep2" class="hidden" style="margin-top:14px"></div>
    </div>
  </div>
</section>

      <section id="page-settings" class="page hidden">
        <div class="panel"><h2 style="margin:0 0 10px">Settings</h2><div class="help">Coming soon…</div></div>
      </section>
    </main>
  </div>

  <div class="fab" id="fabNew"><button class="btn primary" onclick="go('create')">+ New Case</button></div>

  <div class="modal-back" id="modalBack">
    <div class="modal" id="modal">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
        <div class="title" id="modalTitle">Case</div>
        <button class="btn small danger" onclick="closeModal()">Close</button>
      </div>
      <div id="modalBody" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ===== Storage ===== */
const LS_KEY='landa_cases_v13';
function getCases(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return [] } }
function setCases(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); updateKPIs(); }

/* ===== Routing ===== */
const pages=['dashboard','create','cases','diagnosis','settings'];
const fabNew=document.getElementById('fabNew');
function go(route){
  pages.forEach(p=>document.getElementById('page-'+p).classList.add('hidden'));
  const tgt=document.getElementById('page-'+route); if(tgt) tgt.classList.remove('hidden');
  document.querySelectorAll('.nav .item').forEach(a=>a.classList.toggle('active', a.dataset.route===route));
  if(route==='dashboard') updateKPIs();
  if(route==='cases') renderCases();
  if(fabNew) fabNew.style.display = (route==='create') ? 'none' : 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}
document.getElementById('logoHome').addEventListener('click', ()=> go('dashboard'));
document.querySelectorAll('.nav .item').forEach(a=>{
  const r=a.getAttribute('data-route');
  if(r){ a.addEventListener('click', (e)=>{ e.preventDefault(); go(r); if (document.body.classList.contains('aside-open')) document.body.classList.remove('aside-open'); }); }
});
const btnMenu=document.getElementById('btnMenu');
if(btnMenu) btnMenu.addEventListener('click', ()=> document.body.classList.toggle('aside-open'));

/* ===== Auth ===== */
const AUTH_KEY='landaAuth';
const loginPage=document.getElementById('loginPage');
const appRoot=document.getElementById('appRoot');
function showApp(){ loginPage.classList.add('hidden'); appRoot.classList.remove('hidden'); go('dashboard'); updateKPIs(); }
function showLogin(){ appRoot.classList.add('hidden'); loginPage.classList.remove('hidden'); }
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const u=document.getElementById('authUser').value.trim();
  const p=document.getElementById('authPass').value.trim();
  if(u==='Expert' && p==='Landa123456'){
    toast('Welcome, Expert','ok'); localStorage.setItem(AUTH_KEY,'true'); setTimeout(showApp, 650);
  }else{ toast('Invalid credentials','err'); }
});
if(localStorage.getItem(AUTH_KEY)==='true'){ showApp(); }
document.getElementById('btnLogout').addEventListener('click', e=>{
  e.preventDefault(); toast('Logged out successfully','ok'); localStorage.removeItem(AUTH_KEY);
  document.body.classList.remove('aside-open'); setTimeout(showLogin, 650);
});

/* ===== Custom Dropdown Engine ===== */
function makeDropdown(container, { placeholder='Choose…', options=[], onChange=()=>{}, maxHeight=260 }){
  container.classList.add('dd');
  container.innerHTML = `
    <button type="button" class="dd-btn"><span class="dd-label">${placeholder}</span></button>
    <span class="dd-arrow" aria-hidden="true"></span>
    <div class="dd-list" style="max-height:${maxHeight}px"></div>
    <input type="hidden" class="dd-value" value="">
  `;
  const btn = container.querySelector('.dd-btn');
  const list = container.querySelector('.dd-list');
  const label = container.querySelector('.dd-label');
  const input = container.querySelector('.dd-value');
  let state = { open:false, opts:options, index:-1 };

  function render(){
    list.innerHTML = '';
    if(!state.opts || !state.opts.length){ list.innerHTML = `<div class="dd-empty">No options</div>`; return; }
    state.opts.forEach((o,i)=>{
      const it=document.createElement('div'); it.className='dd-item';
      it.setAttribute('data-value',o.value); it.setAttribute('data-index',i);
      if(String(input.value)===String(o.value)) it.setAttribute('aria-selected','true');
      it.textContent=o.label ?? o.value;
      it.addEventListener('click', ()=> selectIndex(i));
      list.appendChild(it);
    });
  }
  function open(){ if(container.classList.contains('disabled')) return;
    container.classList.add('open'); state.open=true;
    const idx=Math.max(0, state.opts.findIndex(o=> String(o.value)===String(input.value)));
    highlight(idx); adjustInView();
    window.addEventListener('click', outside); window.addEventListener('keydown', keys);
  }
  function close(){ container.classList.remove('open'); state.open=false;
    window.removeEventListener('click', outside); window.removeEventListener('keydown', keys); }
  function outside(e){ if(!container.contains(e.target)) close(); }
  function keys(e){
    if(!state.open) return;
    if(e.key==='Escape'){ close(); btn.focus(); }
    else if(e.key==='ArrowDown'){ e.preventDefault(); highlight(Math.min(state.index+1, state.opts.length-1)); adjustInView(); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); highlight(Math.max(state.index-1,0)); adjustInView(); }
    else if(e.key==='Enter'){ e.preventDefault(); if(state.index>=0) selectIndex(state.index); }
  }
  function highlight(i){ state.index=i; [...list.children].forEach(c=>c.classList.remove('hover')); if(list.children[i]) list.children[i].classList.add('hover'); }
  function adjustInView(){ const el=list.children[state.index]; if(!el) return; const r=el.getBoundingClientRect(); const L=list.getBoundingClientRect();
    if(r.top<L.top) list.scrollTop -= (L.top-r.top)+6; if(r.bottom>L.bottom) list.scrollTop += (r.bottom-L.bottom)+6; }
  function selectIndex(i){ const o=state.opts[i]; if(!o) return;
    input.value=o.value; label.textContent=o.label ?? o.value;
    [...list.children].forEach(x=>x.removeAttribute('aria-selected')); if(list.children[i]) list.children[i].setAttribute('aria-selected','true');
    onChange(o.value, o.label ?? o.value); close(); }
  btn.addEventListener('click', ()=> state.open?close():open());
  const api={ setOptions(newOpts){ state.opts=newOpts||[]; render(); if(!state.opts.some(o=> String(o.value)===String(input.value))){ input.value=''; label.textContent=placeholder; } },
              setValue(v){ const i=state.opts.findIndex(o=> String(o.value)===String(v)); if(i>=0){ selectIndex(i); } else { input.value=''; label.textContent=placeholder; } },
              value(){ return input.value }, disable(flag){ container.classList.toggle('disabled', !!flag); } };
  render(); return api;
}

/* ===== Machine Type / Model ===== */
const machineTypeChips=document.getElementById('machineTypeChips');
const hiddenType=document.getElementById('machineType');
const ddModel = makeDropdown(document.getElementById('dd-model'), { placeholder:'Choose…', options:[] });

function fillModels(kind){
  const prefix=(kind==='Duplex')?'D':'S';
  const max=(prefix==='D')?19:9;
  const opts=Array.from({length:max},(_,i)=>({value:`${prefix}${i+1}`,label:`${prefix}${i+1}`}));
  ddModel.setOptions(opts); ddModel.setValue('');
}
fillModels(hiddenType.value||'Simplex');
machineTypeChips.addEventListener('click', (e)=>{
  const chip=e.target.closest('.chip'); if(!chip) return;
  machineTypeChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active'); hiddenType.value=chip.dataset.type; fillModels(hiddenType.value);
});

/* ===== Hierarchical data (from your image – BSS) ===== */
const HIER = {
  "BSS": {
    subSystems: [
      "LIB","BCU","BCD&BTD Motors","BACS","Fly-Off","Air Knife","Hot Plate","Dancer","BCLS","Vacuum Box"
    ],
    categories: {
      "HW": ["Rollers","Sensors","Motors","Brackets","Gaskets","Spare Parts","Pipes","Encoders","Valves"],
      "SW": ["LIA","RTC","OPC","Parameters","Inverters Version"],
      "EC": ["Inverters","Cables","SSR","CB's","FEC's"]
    }
  }
};
// Add other systems here as they arrive:
const SYSTEMS = Object.keys(HIER).map(x=>({value:x,label:x}));

/* ===== Build dynamic dropdowns: System → Sub → Category → Item ===== */
const ddSystem = makeDropdown(document.getElementById('dd-system'), { placeholder:'Choose…', options:SYSTEMS, onChange:onSystem });
const wrapSub = document.getElementById('wrap-sub');
const wrapCat = document.getElementById('wrap-cat');
const wrapItem= document.getElementById('wrap-item');

const ddSub = makeDropdown(document.getElementById('dd-sub'), { placeholder:'Select sub-system…', options:[], onChange:onSub });
const ddCat = makeDropdown(document.getElementById('dd-cat'), { placeholder:'HW / SW / EC', options:[], onChange:onCat });
const ddItem= makeDropdown(document.getElementById('dd-item'), { placeholder:'Select item…', options:[] });

function onSystem(val){
  // Reset downstream
  wrapItem.classList.add('hidden'); ddItem.setOptions([]); ddItem.setValue('');
  wrapCat.classList.add('hidden'); ddCat.setOptions([]); ddCat.setValue('');
  wrapSub.classList.add('hidden'); ddSub.setOptions([]); ddSub.setValue('');

  const node = HIER[val];
  if(!node){ return; }

  // Fill Sub-Systems
  ddSub.setOptions(node.subSystems.map(s=>({value:s,label:s})));
  wrapSub.classList.remove('hidden');
}
function onSub(){
  // Reset deeper levels
  wrapItem.classList.add('hidden'); ddItem.setOptions([]); ddItem.setValue('');
  wrapCat.classList.add('hidden'); ddCat.setOptions([]); ddCat.setValue('');

  const sys = ddSystem.value();
  if(!sys || !HIER[sys]) return;

  // Fill Categories
  const cats = Object.keys(HIER[sys].categories);
  ddCat.setOptions(cats.map(c=>({value:c,label:c})));
  wrapCat.classList.remove('hidden');
}
function onCat(catVal){
  wrapItem.classList.add('hidden'); ddItem.setOptions([]); ddItem.setValue('');
  const sys = ddSystem.value();
  if(!sys || !catVal) return;
  const items = (HIER[sys].categories[catVal] || []).map(x=>({value:x,label:x}));
  ddItem.setOptions(items);
  wrapItem.classList.remove('hidden');
}

/* ===== TFS toggle ===== */
const tfsToggle=document.getElementById('tfsToggle');
const tfsNumber=document.getElementById('tfsNumber');
tfsToggle.addEventListener('change', ()=>{
  if(tfsToggle.checked){ tfsNumber.classList.remove('hidden'); tfsNumber.focus(); }
  else { tfsNumber.classList.add('hidden'); tfsNumber.value=''; }
});

/* ===== Troubleshooting steps ===== */
const tsSteps=document.getElementById('tsSteps');
function addStep(val=''){
  const row=document.createElement('div'); row.className='inline'; row.style.margin='6px 0';
  const inp=document.createElement('input'); inp.className='input v13'; inp.placeholder='Describe a step…'; inp.value=val; inp.style.flex='1';
  const rm=document.createElement('button'); rm.className='btn small danger'; rm.type='button'; rm.textContent='Remove'; rm.onclick=()=>row.remove();
  row.appendChild(inp); row.appendChild(rm); tsSteps.appendChild(row);
}
addStep('Check connections and sensors');
addStep('Verify model-specific settings');

/* ===== Part smart suggest (demo) ===== */
const partInput=document.getElementById('partInput');
const partSuggest=document.getElementById('partSuggest');
if(partInput){
  const parts=Array.from({length:160},(_,i)=> ((i%2===0)?'12':'34') + '-' + String(10000+i).slice(-5));
  const filterParts=q=>{const v=String(q||'').trim().toLowerCase(); if(!v) return []; return parts.filter(p=>p.toLowerCase().includes(v)).slice(0,30)};
  partInput.addEventListener('input', ()=>{
    const list=filterParts(partInput.value); partSuggest.innerHTML='';
    if(!list.length){ partSuggest.style.display='none'; return }
    list.forEach(p=>{ const row=document.createElement('div'); row.textContent=p; row.addEventListener('click',()=>{partInput.value=p; partSuggest.style.display='none'}); partSuggest.appendChild(row) });
    partSuggest.style.display='block';
  });
  document.addEventListener('click',(e)=>{ if(!partSuggest.contains(e.target) && e.target!==partInput){ partSuggest.style.display='none' }});
}

/* ===== Files ===== */
function addFileRow(){
  const w=document.getElementById('filesWrap');
  const row=document.createElement('div'); row.className='inline';
  const inp=document.createElement('input'); inp.type='file'; inp.className='file'; inp.accept='.pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.zip';
  const rm=document.createElement('button'); rm.className='btn small danger'; rm.type='button'; rm.textContent='Remove'; rm.onclick=()=>row.remove();
  row.appendChild(inp); row.appendChild(rm); w.appendChild(row);
}
addFileRow();

/* ===== Save Case ===== */
async function saveCase(e){
  e.preventDefault();
  const req=v=>v&&String(v).trim().length>0;

  const data={
    sfCase:val('sfCase'),
    tfsNumber: tfsToggle.checked ? val('tfsNumber') : '',
    machineType: val('machineType'),
    model: ddModel.value(),
    system: ddSystem.value(),
    subSystem: ddSub.value(),
    category: ddCat.value(),
    item: ddItem.value(),
    softwareVersion: val('softwareVersion'),
    issueSummary: val('issueSummary'),
    symptoms: val('symptoms'),
    troubleshooting: collectSteps(),
    partCatalog: val('partInput'),
    solution: val('solution'),
    verification: val('verification'),
    notes: val('notes'),
    attachments: [],
    createdAt: new Date().toISOString(),
    author:'Expert'
  };

  const errors=[];
  if(!req(data.sfCase))errors.push('sfCase');
  if(!req(data.model))errors.push('model');
  if(!req(data.system))errors.push('system');
  if(!req(data.subSystem))errors.push('subSystem');
  if(!req(data.category))errors.push('category');
  if(!req(data.item))errors.push('item');
  if(!req(data.issueSummary))errors.push('issueSummary');
  if(!req(data.solution))errors.push('solution');

  if(errors.length){ toast('Please fill required: '+errors.join(', '),'err'); return; }

  // files
  const inputs=[...document.querySelectorAll('#filesWrap input[type="file"]')];
  const files=inputs.map(i=>i.files&&i.files[0]).filter(Boolean);
  if(files.length){ for(const f of files){
      const ok=/\.(pdf|docx?|xlsx?|png|jpg|jpeg|zip)$/i.test(f.name);
      if(!ok){ toast('Unsupported file: '+f.name,'err'); continue }
      const base64=await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f) });
      data.attachments.push({name:f.name,type:f.type,data:base64});
    } }

  const arr=getCases(); arr.push(data); setCases(arr);

  // reset
  document.getElementById('caseForm').reset();
  hiddenType.value='Simplex';
  machineTypeChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  machineTypeChips.querySelector('[data-type="Simplex"]').classList.add('active');
  fillModels('Simplex');

  ddSystem.setValue(''); ddSub.setOptions([]); ddSub.setValue('');
  ddCat.setOptions([]); ddCat.setValue(''); ddItem.setOptions([]); ddItem.setValue('');
  wrapSub.classList.add('hidden'); wrapCat.classList.add('hidden'); wrapItem.classList.add('hidden');

  document.getElementById('filesWrap').innerHTML=''; addFileRow();
  tsSteps.innerHTML=''; addStep('Check connections and sensors'); addStep('Verify model-specific settings');

  toast('Case saved successfully','ok'); go('cases');
}
function collectSteps(){ return [...tsSteps.querySelectorAll('.inline input')].map(i=>i.value).filter(v=>String(v).trim()).join('\n') }
function val(id){ const el=document.getElementById(id); return el?el.value:'' }

/* ===== Cases render ===== */
function renderCases(){
  const list=document.getElementById('casesList');
  const q=(document.getElementById('searchBox').value||'').toLowerCase();
  const arr=getCases().filter(c=> !q ||
    (c.issueSummary||'').toLowerCase().includes(q) ||
    (c.model||'').toLowerCase().includes(q) ||
    (c.system||'').toLowerCase().includes(q) ||
    (c.item||'').toLowerCase().includes(q)
  );
  const badge=document.getElementById('casesCount'); if(badge) badge.textContent=String(arr.length);
  list.innerHTML = arr.length ? arr.map((c,i)=>caseCard(c,i)).join('') : '<div class="panel">No cases yet.</div>';
}
function caseCard(c,i){
  const files=Array.isArray(c.attachments)&&c.attachments.length? `${c.attachments.length} file(s)` : 'No attachments';
  return `<div class="case-card">
    <div class="stripe"></div>
    <div>
      <div class="title">#${i+1} — ${esc(c.sfCase||'')}</div>
      <div class="meta">
        <span class="kv"><span class="k">Model:</span><span class="v">${esc(c.model||'')} (${esc(c.machineType||'')})</span></span>
        <span class="kv"><span class="k">System:</span><span class="v">${esc(c.system||'')} / ${esc(c.subSystem||'')}</span></span>
        <span class="kv"><span class="k">Category:</span><span class="v">${esc(c.category||'')} → ${esc(c.item||'')}</span></span>
        <span class="kv"><span class="k">SW:</span><span class="v">${esc(c.softwareVersion||'')}</span></span>
      </div>
      <div class="kv" style="margin-top:8px"><span class="k">Issue:</span><span class="v">${esc(c.issueSummary||'')}</span></div>
      <div class="files" style="margin-top:4px">${files}</div>
    </div>
    <div class="actions">
      <button class="btn small" onclick="openCase(${i})">Details</button>
      <button class="btn small danger" onclick="deleteCase(${i})">Delete</button>
    </div>
  </div>`;
}
function openCase(i){
  const c=getCases()[i]; if(!c) return; document.getElementById('modalTitle').textContent=`Case #${i+1} — ${c.sfCase||''}`;
  const files=Array.isArray(c.attachments)&&c.attachments.length?
    c.attachments.map(a=>`<div class="kv"><span class="k">•</span><a class="btn small" href="${a.data}" target="_blank" rel="noopener">View</a> <a class="btn small" href="${a.data}" download="${a.name}">Download</a> <span class="v">${esc(a.name)}</span></div>`).join('')
    : '<div class="attach-empty">No attachments</div>';
  document.getElementById('modalBody').innerHTML = `
    <div class="grid cols-2">
      <div class="panel">
        <div class="kv"><span class="k">Model:</span><span class="v">${esc(c.model||'')} (${esc(c.machineType||'')})</span></div>
        <div class="kv"><span class="k">System:</span><span class="v">${esc(c.system||'')} / ${esc(c.subSystem||'')}</span></div>
        <div class="kv"><span class="k">Category:</span><span class="v">${esc(c.category||'')} → ${esc(c.item||'')}</span></div>
        <div class="kv"><span class="k">Software:</span><span class="v">${esc(c.softwareVersion||'')}</span></div>
        <div class="kv"><span class="k">TFS:</span><span class="v">${esc(c.tfsNumber||'')}</span></div>
      </div>
      <div class="panel">
        <div class="kv"><span class="k">Opened:</span><span class="v">${new Date(c.createdAt).toLocaleString()}</span></div>
        <div class="kv"><span class="k">Author:</span><span class="v">${esc(c.author||'')}</span></div>
      </div>
    </div>
    <div class="panel" style="margin-top:12px"><h3>Problem</h3>
      <div class="kv"><span class="k">Summary:</span><span class="v">${esc(c.issueSummary||'')}</span></div>
      <div class="kv"><span class="k">Symptoms:</span><span class="v">${nl(esc(c.symptoms||''))}</span></div>
    </div>
    <div class="panel" style="margin-top:12px"><h3>Solution</h3>
      <div class="kv"><span class="k">Troubleshooting:</span><span class="v">${nl(esc(c.troubleshooting||''))}</span></div>
      <div class="kv"><span class="k">Part (catalog):</span><span class="v">${esc(c.partCatalog||'')}</span></div>
      <div class="kv"><span class="k">Implemented:</span><span class="v">${nl(esc(c.solution||''))}</span></div>
      <div class="kv"><span class="k">Verification:</span><span class="v">${esc(c.verification||'')}</span></div>
      <div class="kv"><span class="k">Notes:</span><span class="v">${nl(esc(c.notes||''))}</span></div>
      <div class="kv" style="margin-top:12px"><span class="k">Files:</span><span class="v">${files}</span></div>
    </div>`;
  openModal();
}
function deleteCase(i){ const arr=getCases(); if(!arr[i]) return; if(!confirm('Delete this case?')) return; arr.splice(i,1); setCases(arr); renderCases(); toast('Case deleted','ok'); }
function openModal(){ document.getElementById('modalBack').style.display='flex'; }
function closeModal(){ document.getElementById('modalBack').style.display='none'; }
function updateKPIs(){
  const arr=getCases(); document.getElementById('kpiTotal').textContent=arr.length;
  document.getElementById('kpiFiles').textContent=arr.filter(c=>Array.isArray(c.attachments)&&c.attachments.length).length;
  const last=arr.length? new Date(arr[arr.length-1].createdAt).toLocaleString() : '—';
  document.getElementById('kpiUpdated').textContent=last;
  const pageCasesCount=document.getElementById('casesCount'); if(pageCasesCount) pageCasesCount.textContent=String(arr.length);
}
function exportCSV(){
  const arr=getCases();
  const cols=['sfCase','tfsNumber','machineType','model','system','subSystem','category','item','softwareVersion','issueSummary','symptoms','troubleshooting','partCatalog','solution','verification','notes','attachments','createdAt','author'];
  const csv=[cols.join(',')].concat(arr.map(o=> cols.map(k=> JSON.stringify((Array.isArray(o[k])? o[k].length+' file(s)' : (o[k]||'')).toString().replace(/\n/g,' '))).join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='landa_cases.csv'; a.click();
}
function toast(msg,type='ok'){ const t=document.createElement('div'); t.className='toast '+type; t.textContent=msg; const w=document.getElementById('toasts'); w.appendChild(t); setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),250)},1600); }
function esc(s){ return (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) } function nl(s){ return String(s||'').replace(/\n/g,'<br>') }

/* ===== Particles ===== */
(function(){
  const c=document.getElementById('particles'); if(!c) return; const ctx=c.getContext('2d'); let w,h;
  function resize(){ w=c.width=innerWidth; h=c.height=innerHeight; }
  addEventListener('resize',resize); resize();
  const dots=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.6+0.6,vx:(Math.random()-.5)*0.28,vy:(Math.random()-.5)*0.28}));
  function step(){
    ctx.clearRect(0,0,w,h);
    for(const d of dots){
      d.x+=d.vx; d.y+=d.vy;
      if(d.x<0||d.x>w) d.vx*=-1; if(d.y<0||d.y>h) d.vy*=-1;
      ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
      ctx.fillStyle='rgba(59,208,255,0.25)'; ctx.fill();
    }
    requestAnimationFrame(step);
  }
  step();
})();

/* ===== Root Cause Analyzer logic ===== */
function selectDiagnosis(type){
  const step1 = document.getElementById('diagStep1');
  const step2 = document.getElementById('diagStep2');
  step2.classList.remove('hidden');
  step2.innerHTML = renderChecklist(type);
  step1.scrollIntoView({behavior:'smooth'});
  localStorage.setItem('landa_diag_state', type);
}

function renderChecklist(type){
  let title='', checks=[];
  if(type==='drying'){
    title='Drying System Diagnostic';
    checks=[
      'Check IR lamp status and operation',
      'Verify temperature sensor readings',
      'Inspect airflow and exhaust levels',
      'Confirm paper transport speed',
      'Ensure drying rollers are clean and rotating'
    ];
  }else if(type==='coating'){
    title='Coating System Diagnostic';
    checks=[
      'Verify coating pump pressure',
      'Check coating viscosity and level',
      'Inspect applicator alignment',
      'Ensure UV lamps are operational',
      'Confirm correct coating profile is loaded'
    ];
  }else if(type==='both'){
    title='Full Machine Diagnostic';
    checks=[
      'Inspect both drying and coating systems',
      'Run humidity calibration',
      'Verify general temperature sensors',
      'Check overall machine ventilation',
      'Review latest software parameters for SetOff issue'
    ];
  }
  return `
  <div class="panel">
    <h3>${title}</h3>
    <p>Mark each step as completed:</p>
    <div id="checklist" class="grid cols-1" style="gap:6px;margin-top:6px">
      ${checks.map((c,i)=>`
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="chk${i}" onchange="saveChecklist()">
          <span>${c}</span>
        </label>`).join('')}
    </div>
    <button class="btn small" style="margin-top:12px" onclick="restartDiagnosis()">Restart Diagnosis</button>
  </div>`;
}

function saveChecklist(){
  const boxes=[...document.querySelectorAll('#checklist input[type="checkbox"]')];
  const done=boxes.map(b=>b.checked);
  localStorage.setItem('landa_diag_checklist', JSON.stringify(done));
}

function restartDiagnosis(){
  localStorage.removeItem('landa_diag_state');
  localStorage.removeItem('landa_diag_checklist');
  const step2=document.getElementById('diagStep2');
  step2.innerHTML=''; step2.classList.add('hidden');
  toast('Diagnosis restarted','ok');
}

function startDiagnosis(type){
  localStorage.setItem('landa_diag_issue', type);
  document.getElementById('diagSelect').classList.add('hidden');
  document.getElementById('diagStep1').classList.remove('hidden');

 const issueMap = {
  setoff:'SetOff',
  scratches:'Scratches',
  uniformity:'Uniformity',
  jetting:'Jetting',
  transfer:'Transfer'
};
  const issueName = issueMap[type] || 'General';
  document.querySelector('#diagStep1 h3 span').textContent = issueName;

  // reset step2
  const step2 = document.getElementById('diagStep2');
  step2.innerHTML = '';
  step2.classList.add('hidden');
  localStorage.removeItem('landa_diag_state');
  localStorage.removeItem('landa_diag_checklist');
}

function backToIssueSelect(){
  localStorage.removeItem('landa_diag_issue');
  localStorage.removeItem('landa_diag_state');
  localStorage.removeItem('landa_diag_checklist');

  document.getElementById('diagStep1').classList.add('hidden');
  const step2 = document.getElementById('diagStep2');
  step2.innerHTML = '';
  step2.classList.add('hidden');

  document.getElementById('diagSelect').classList.remove('hidden');
  document.getElementById('diagSelect').scrollIntoView({behavior:'smooth', block:'start'});
}

function loadDiagnosis(){
  const issue = localStorage.getItem('landa_diag_issue');
  const state = localStorage.getItem('landa_diag_state');

  const sel   = document.getElementById('diagSelect');
  const step1 = document.getElementById('diagStep1');
  const step2 = document.getElementById('diagStep2');

  const issueMap = {
    scratches:'Scratches', uniformity:'Uniformity',
    jetting:'Jetting',     transfer:'Transfer'
  };

  if (issue) {
    sel.classList.add('hidden');
    step1.classList.remove('hidden');
    const name = issueMap[issue] || 'General';
    document.querySelector('#diagStep1 h3 span').textContent = name;

    if (state) {
      step2.innerHTML = renderChecklist(state);
      step2.classList.remove('hidden');
      const saved = JSON.parse(localStorage.getItem('landa_diag_checklist') || '[]');
      saved.forEach((v,i)=>{ const el=document.getElementById('chk'+i); if(el) el.checked=v; });
    } else {
      step2.innerHTML = '';
      step2.classList.add('hidden');
    }
  } else {
    sel.classList.remove('hidden');
    step1.classList.add('hidden');
    step2.innerHTML = '';
    step2.classList.add('hidden');
  }
}

loadDiagnosis();
go('dashboard');
</script>
</body>
</html>
